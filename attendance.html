<!DOCTYPE html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, shrink-to-fit=no"
    />
    <link
      href="https://fonts.googleapis.com/css?family=Roboto:300,400&display=swap"
      rel="stylesheet"
    />

    <link rel="stylesheet" href="fonts/icomoon/style.css" />

    <link rel="stylesheet" href="css/owl.carousel.min.css" />
    <link rel="icon" type="image/png" href="/images/logo.png" />

    <!-- Style -->
    <link rel="stylesheet" href="css/style.css" />
    <link rel="stylesheet" href="css/attendance.css" />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@4.4.1/dist/css/bootstrap.min.css"
      integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh"
      crossorigin="anonymous"
    />

    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@600&family=Poppins:wght@300&display=swap"
      rel="stylesheet"
    />
    <title>Attendance</title>
  </head>

  <body>
    <header style="display: flex; margin-top: 20px">
      <a href="home.html"><img src="images/FBEYE.png" class="logo-img" /></a>

      <input type="checkbox" id="nav_check" hidden />
      <nav>
        <ul>
          <li>
            <a href="homeE.html" class="active">Home</a>
          </li>
          <li>
            <a href="index.html">Logout</a>
          </li>
        </ul>
      </nav>
      <label for="nav_check" class="hamburger">
        <div></div>
        <div></div>
        <div></div>
      </label>
    </header>

    <main class="table" style="width: 93vw">
      <section class="table__body">
        <table>
          <thead>
            <tr style="color: white">
              <th>Date <span class="icon-arrow">&UpArrow;</span></th>
              <th>Clock In Time <span class="icon-arrow">&UpArrow;</span></th>
              <th>Clock Out Time <span class="icon-arrow">&UpArrow;</span></th>
              <th>Status <span class="icon-arrow">&UpArrow;</span></th>
            </tr>
          </thead>

          <tbody id="myTableBody">
            <!-- Attendance records will be inserted here dynamically -->
          </tbody>
        </table>
      </section>
    </main>

    <script
      src="https://unpkg.com/@dotlottie/player-component@latest/dist/dotlottie-player.mjs"
      type="module"
    ></script>
    <script
      type="module"
      src="https://www.gstatic.com/firebasejs/10.6.0/firebase-app.js"
    ></script>
    <script
      type="module"
      src="https://www.gstatic.com/firebasejs/10.6.0/firebase-auth.js"
    ></script>
    <script
      type="module"
      src="https://www.gstatic.com/firebasejs/10.6.0/firebase-database.js"
    ></script>
    <script
      type="module"
      src="https://www.gstatic.com/firebasejs/10.6.0/firebase-storage.js"
    ></script>
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-app.js";

      import {
        getDatabase,
        update,
        ref,
        get,
        child,
        onValue,
      } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-database.js";

      import {
        getStorage,
        getDownloadURL,
        ref as storageRef,
      } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-storage.js";

      const firebaseConfig = {
        apiKey: "AIzaSyAQDU7-hbWtI3sa3s3woi4YfUJtiVRYhGg",
        authDomain: "fbeye-bf2f1.firebaseapp.com",
        databaseURL:
          "https://fbeye-bf2f1-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "fbeye-bf2f1",
        storageBucket: "fbeye-bf2f1.appspot.com",
        messagingSenderId: "462631567055",
        appId: "1:462631567055:web:bc8ee774e09e56e8fcc1ba",
      };

      const app = initializeApp(firebaseConfig);
      const db = getDatabase();
      const storage = getStorage();

      const userID = sessionStorage.getItem("employeeUID");

      function AddAllItemsToTable(clockInData, clockOutData, employeeDetails) {
        const tableBody = document.getElementById("myTableBody");
        let tableContent = "";

        // Filter data for the specific user
        const userClockInData = clockInData.filter(
          (entry) => entry.userID === userID
        );
        const userClockOutData = clockOutData.filter(
          (entry) => entry.userID === userID
        );

        // Check if the user has any ClockIn entries
        const hasClockInEntries = userClockInData.length > 0;

        // Define getClockOutTime function
        function getClockOutTime(clockOutData, date) {
          const entry = clockOutData.find((outEntry) => outEntry.Date === date);
          return entry ? entry.ClockOutTime : null;
        }

        // Iterate over dates
        userClockInData.forEach((entry) => {
          const clockOutTime = getClockOutTime(userClockOutData, entry.Date);
          const attendanceStatus = getAttendanceStatus(
            entry.ClockInTime,
            clockOutTime
          );

          const rowHTML = `<tr>
      <td>${entry.Date}</td>
      <td>${entry.ClockInTime || "-"}</td>
      <td>${clockOutTime || "-"}</td>
      <td>
        <p class="status ${attendanceStatus}">${attendanceStatus}</p>
      </td>
    </tr>`;

          tableContent += rowHTML;
        });

        // If the user has no ClockIn entries, mark them as Absent
        if (!hasClockInEntries) {
          const today = new Date().toISOString().slice(0, 10);
          const rowHTML = `<tr>
      <td>${today}</td>
      <td>-</td>
      <td>-</td>
      <td>
        <p class="status Absent">Absent</p>
      </td>
    </tr>`;
          tableContent += rowHTML;
        }

        // Update the table body with the generated content
        tableBody.innerHTML = tableContent;
      }

      function getAttendanceStatus(clockInTime, clockOutTime) {
        if (clockInTime) {
          return "Present";
        } else if (clockOutTime) {
          return "Absent (Clock In Missed)";
        } else {
          return "Absent";
        }
      }

      function GetAllDataRealTime() {
        const clockInRef = ref(db, "ClockInLog");
        const clockOutRef = ref(db, "ClockOutLog");

        Promise.all([get(clockInRef), get(clockOutRef)]).then(
          ([clockInSnapshot, clockOutSnapshot]) => {
            const clockInData = [];
            clockInSnapshot.forEach((dateSnapshot) => {
              dateSnapshot.forEach((childSnapshot) => {
                const entry = {
                  userID: childSnapshot.key,
                  Date: dateSnapshot.key,
                  ClockInTime: childSnapshot.val(),
                };
                clockInData.push(entry);
              });
            });

            const clockOutData = [];
            clockOutSnapshot.forEach((dateSnapshot) => {
              dateSnapshot.forEach((childSnapshot) => {
                const entry = {
                  userID: childSnapshot.key,
                  Date: dateSnapshot.key,
                  ClockOutTime: childSnapshot.val(),
                };
                clockOutData.push(entry);
              });
            });

            // Retrieve additional details about employees from the Employees node
            const employeesDetailsRef = ref(db, "Employees");
            get(employeesDetailsRef).then((detailsSnapshot) => {
              const employeesDetails = [];
              detailsSnapshot.forEach((employeeSnapshot) => {
                employeesDetails.push(employeeSnapshot.val());
              });

              AddAllItemsToTable(clockInData, clockOutData, employeesDetails);
            });
          }
        );
      }

      GetAllDataRealTime();
    </script>
  </body>
</html>
