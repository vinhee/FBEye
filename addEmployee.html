<!DOCTYPE html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, shrink-to-fit=no"
    />
    <link
      href="https://fonts.googleapis.com/css?family=Roboto:300,400&display=swap"
      rel="stylesheet"
    />

    <link rel="stylesheet" href="fonts/icomoon/style.css" />

    <link rel="stylesheet" href="css/owl.carousel.min.css" />
    <link rel="icon" type="image/png" href="/images/logo.png" />

    <!-- Style -->
    <link rel="stylesheet" href="css/style.css" />
    <link rel="stylesheet" href="css/attendance.css" />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@4.4.1/dist/css/bootstrap.min.css"
      integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh"
      crossorigin="anonymous"
    />

    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@600&family=Poppins:wght@300&display=swap"
      rel="stylesheet"
    />
    <title> Add New Employee </title>
  </head>

  <body>
    <header style="display: flex; margin-top: 20px">
     <img src="images/FBEYE.png" class="logo-img" />

      <input type="checkbox" id="nav_check" hidden />
      <nav>
        <ul>
          <li>
            <a href="admin.html" class="active">Home</a>
          </li>
          <li>
            <a href="index.html">Logout</a>
          </li>
        </ul>
      </nav>
      <label for="nav_check" class="hamburger">
        <div></div>
        <div></div>
        <div></div>
      </label>
    </header>

    <body>

  <div class="col">
<div class="row">
<div class="col mb-3">
<div class="card" style="margin-top: 30px; margin-left: 30px; margin-right: 30px;">
<div class="card-body">
<div class="e-profile">
<div class="row">
<div class="col-12 col-sm-auto mb-3">
<div class="mx-auto" style="width: 140px;">
<div class="d-flex justify-content-center align-items-center rounded" style="height: 140px; background-color: rgb(233, 236, 239);">
  <span style="color: rgb(166, 168, 170); font: bold 8pt Arial;" id="sizeImag">140x140</span>
  <div class="d-flex justify-content-center align-items-center rounded" style="height: 140px; background-color: rgb(233, 236, 239);">
    <img id="selectedProfilePicture" style="width: 140px; height: 140px; display: none;">
  </div>
</div>
</div>
</div>
<div class="col d-flex flex-column flex-sm-row justify-content-between mb-3">
<div class="text-center text-sm-left mb-2 mb-sm-0" style="margin-top: auto;">

<div class="mt-2">  
<button id="addPicBtn" class="btn btn-primary" type="button">
    <i class="fa fa-fw fa-camera"></i>
    <span>Add Profile Picture</span>
</button>
<input type="file" accept="image/*" id="profilePicture" class="form-control" style="display: none;">

</div>
</div>

 <!-- onclick="document.getElementById('profilePicture').click();" -->

<div class="text-center text-sm-right">
<span class="badge badge-secondary">administrator</span>
<div class="text-muted"><small id="joinDate">Joined 09 Dec 2017</small></div>
</div>
</div>
</div>
<ul class="nav nav-tabs">
<li class="nav-item"><a href class="active nav-link">Add New Employee Information</a></li>
</ul>
<div class="tab-content pt-3">
<div class="tab-pane active">
<form class="form" novalidate>
<div class="row">
<div class="col">
<div class="row">
<div class="col">
<div class="form-group">
<label>Full Name</label>
<input class="form-control" type="text" name="name" id="name" required>
</div>
</div>
<div class="col">
<div class="form-group">
<label>Phone Number</label>
<input class="form-control" type="text" name="phonenumber" id="phoneNo" required>
</div>
</div>
</div>

<div class="row">
<div class="col">
<div class="row">
<div class="col">
<div class="form-group">
<label>Email</label>
<input class="form-control" type="text" name="email" id="email" required>
</div>
</div>
<div class="col">
<div class="form-group">
<label>Gender</label>
 <select name="gender" id="gender" class="form-control" id="gender" required>
    <option value="-"></option>       
    <option value="male">Male</option>       
    <option value="female">Female</option>       
  </select> 
</div>
</div>
</div>

<div class="row">
<div class="col">
<div class="row">
<div class="col">
<div class="form-group">
<label>Department</label>
<input class="form-control" type="text" name="Department" id="department" required>
</div>
</div>
<div class="col">
<div class="form-group">
<label>Role</label>
<input class="form-control" type="text" name="role" id="role" required>
</div>
</div>
</div>





<div class="row">
<div class="col-12 col-sm-6 mb-3">
<div class="mb-2"><b>Set New Password</b></div>
<div class="row">
<div class="col">
<div class="form-group">
<label>New Password</label>
<input class="form-control" type="password" id="newPassword">
</div>
</div>
</div> 
<div class="row">
<div class="col">
<div class="form-group">
<label>Confirm Password</label>
<input class="form-control" type="password" id="confirmPassword">
</div>
</div>
</div> 
</div>
</div>
<div class="d-flex justify-content-end" style="margin-top: 20px;">
  <button class="btn btn-primary" type="submit" id="addRecord">Add Record</button>
</div>
</form>
</div>
</div>
</div>
</div>
</div>
</div>

    </body>
    
       
 
  <script type="module">

    
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
    import { getDatabase, update, ref, get, set } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-database.js";
    import { getAuth, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js";
    import {getStorage, ref as storageRef, uploadBytes} from "https://www.gstatic.com/firebasejs/10.7.0/firebase-storage.js";

    const firebaseConfig = {
        apiKey: "AIzaSyAQDU7-hbWtI3sa3s3woi4YfUJtiVRYhGg",
        authDomain: "fbeye-bf2f1.firebaseapp.com",
        databaseURL: "https://fbeye-bf2f1-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "fbeye-bf2f1",
        storageBucket: "fbeye-bf2f1.appspot.com",
        messagingSenderId: "462631567055",
        appId: "1:462631567055:web:bc8ee774e09e56e8fcc1ba",
        measurementId: "G-83NWPL2V92"
      };

    const app = initializeApp(firebaseConfig);
    const database = getDatabase(app);
    const auth = getAuth();
    const storage = getStorage(app);
    let generatedEmployeeID = 0;

    // Fetch the maximum employee ID from the database
    const employeeRef = ref(database, 'Employees');
    get(employeeRef).then((snapshot) => {
      if (snapshot.exists()) {
        const employees = snapshot.val();
        let maxEmployeeID = 0;

        for (const key in employees) {
          const employee = employees[key];
          if (employee.EmployeeID > maxEmployeeID) {
            maxEmployeeID = employee.EmployeeID;
          }
        }
        generatedEmployeeID = maxEmployeeID + 1;
      }
    });
    

    function generateEmployeeID() {
      return generatedEmployeeID++;
    }


    function createUser() {
      const name = document.getElementById("name").value;
      const phoneNo = document.getElementById("phoneNo").value;
      const email = document.getElementById("email").value;
      const gender = document.getElementById("gender").value;
      const department = document.getElementById("department").value;
      const role = document.getElementById("role").value;
      const newPassword = document.getElementById("newPassword").value;
      const confirmPassword = document.getElementById("confirmPassword").value;
      const employeeID = generateEmployeeID();
      const joinDate = new Date().toLocaleDateString('en-US', {
            year: 'numeric',
            month: 'short',
            day: '2-digit',
      });
    

      const profilePictureInput = document.getElementById("profilePicture");
      const selectedProfilePicture = document.getElementById("selectedProfilePicture");
      const profilePictureFile = profilePictureInput.files[0];

    //   if (profilePictureFile) {
    //   const reader = new FileReader();
    //   reader.onload = function (e) {
    //     selectedProfilePicture.src = e.target.result;
    //     selectedProfilePicture.style.display = "block";
    //   };
    //   reader.readAsDataURL(profilePictureFile);
    // }

    if (newPassword === confirmPassword) {
      createUserWithEmailAndPassword(auth, email, confirmPassword)
        .then((userCredential) => {
          const user = userCredential.user;
          const userID = user.uid;

          if (profilePictureFile) {
            const storageReference = storageRef(storage, `ProfilePicture/${userID}.png`);
            uploadBytes(storageReference, profilePictureFile)
              .then(() => {
                set(ref(database, 'Employees/' + userID), {
                  Name: name,
                  EmployeeID: employeeID,
                  PhoneNumber: phoneNo,
                  Email: email,
                  JoinDate: joinDate,
                  Department: department,
                  Role: role,
                  Gender: gender,
                  userID: userID
                });

                console.log("User created successfully!");
                window.location.href="admin.html";

              })
              .catch((error) => {
                alert("Error uploading profile picture: " + error.message);
              });
          } else {
            set(ref(database, 'Employees/' + userID), {
              Name: name,
              EmployeeID: employeeID,
              PhoneNumber: phoneNo,
              Email: email,
              JoinDate: joinDate,
              Department: department,
              Role: role,
              Gender: gender,
              userID: userID
            });

            console.log("User created successfully!");
            window.location.href="admin.html";

          }
        })
        .catch((error) => {
          var errorCode = error.code;
          var errorMessage = error.message;
          alert("Error: " + errorMessage);
        });
    } else {
      alert("Password does not match!");
    }
  }

  document.getElementById("addPicBtn").addEventListener("click", (e) => {
        const profilePictureInput = document.getElementById("profilePicture");
        const selectedProfilePicture = document.getElementById("selectedProfilePicture");

        profilePictureInput.addEventListener("change", function () {
            const profilePictureFile = profilePictureInput.files[0];

            if (profilePictureFile) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    selectedProfilePicture.src = e.target.result;
                    selectedProfilePicture.style.display = "block";
                    sizeImag.style.display = "none"; 

                  };
                reader.readAsDataURL(profilePictureFile);
            }
        });

        // Trigger the file input click event
        profilePictureInput.click();
    });

    
    document.getElementById("addRecord").addEventListener("click", (e) => {
      e.preventDefault();
      createUser();
    });
    

    

  </script>
</body>
</html>